执行计划之type
```
1、const
2、eq_ref
3、ref
4、range
5、index
6、all
```
一、const  使用primary key 或者unique取得一条数据,特点是show warnings \G可以显示常 数
```
root@192.168.0.254 3307 [employees]>desc select * from employees where emp_no=10001;s;
+----+-------------+-----------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
| id | select_type | table     | partitions | type  | possible_keys | key     | key_len | ref   | rows | filtered | Extra |
+----+-------------+-----------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | employees | NULL       | const | PRIMARY       | PRIMARY | 4       | const |    1 |   100.00 | NULL  |
+----+-------------+-----------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
1 row in set, 1 warning (0.00 sec)

root@192.168.0.254 3307 [employees]>show warnings;
+-------+------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Level | Code | Message                                                                                                                                                                                                   |
+-------+------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Note  | 1003 | /* select#1 */ select '10001' AS `emp_no`,'1953-09-02' AS `birth_date`,'Georgi' AS `first_name`,'Facello' AS `last_name`,'M' AS `gender`,'1986-06-26' AS `hire_date` from `employees`.`employees` where 1 |
+-------+------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
```
二、eq_ref
1) 必须是join
2) 且满足被驱动表的连接条件unique key 或者primary key
```
root@192.168.0.254 3307 [employees]>desc select * from dept_emp d join employees e on d.emp_no=e.emp_no where d.dept_no='d005';
+----+-------------+-------+------------+--------+------------------------+---------+---------+--------------------+--------+----------+-------+
| id | select_type | table | partitions | type   | possible_keys          | key     | key_len | ref                | rows   | filtered | Extra |
+----+-------------+-------+------------+--------+------------------------+---------+---------+--------------------+--------+----------+-------+
|  1 | SIMPLE      | d     | NULL       | ref    | PRIMARY,emp_no,dept_no | dept_no | 12      | const              | 148054 |   100.00 | NULL  |
|  1 | SIMPLE      | e     | NULL       | eq_ref | PRIMARY                | PRIMARY | 4       | employees.d.emp_no |      1 |   100.00 | NULL  |
+----+-------------+-------+------------+--------+------------------------+---------+---------+--------------------+--------+----------+-------+
2 rows in set, 1 warning (0.05 sec)
```
三、ref
对索引列进行 = 条件,如果是联合索引，应查看是否发生ICP，不然也应该是一个优化对象
```
root@192.168.0.254 3307 [employees]>desc select * from dept_emp d where d.dept_no='d005';
+----+-------------+-------+------------+------+---------------+---------+---------+-------+--------+----------+-------+
| id | select_type | table | partitions | type | possible_keys | key     | key_len | ref   | rows   | filtered | Extra |
+----+-------------+-------+------------+------+---------------+---------+---------+-------+--------+----------+-------+
|  1 | SIMPLE      | d     | NULL       | ref  | dept_no       | dept_no | 12      | const | 148054 |   100.00 | NULL  |
+----+-------------+-------+------------+------+---------------+---------+---------+-------+--------+----------+-------+
1 row in set, 1 warning (0.00 sec)

例:
root@192.168.0.254 3307 [employees]>show index from salaries;   //表索引
+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table    | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| salaries |          0 | PRIMARY  |            1 | emp_no      | A         |      271553 |     NULL | NULL   |      | BTREE      |         |               |
| salaries |          0 | PRIMARY  |            2 | from_date   | A         |     2580175 |     NULL | NULL   |      | BTREE      |         |               |
| salaries |          1 | emp_no   |            1 | emp_no      | A         |      268550 |     NULL | NULL   |      | BTREE      |         |               |
+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+

root@192.168.0.254 3307 [employees]>desc select * from salaries s  where emp_no=10001 and from_date like '1986%';      //如果有联合索引，那么此时的type=ref就是一个优化的对象
+----+-------------+-------+------------+------+----------------+---------+---------+-------+------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys  | key     | key_len | ref   | rows | filtered | Extra       |
+----+-------------+-------+------------+------+----------------+---------+---------+-------+------+----------+-------------+
|  1 | SIMPLE      | s     | NULL       | ref  | PRIMARY,emp_no | PRIMARY | 4       | const |   17 |    11.11 | Using where |
+----+-------------+-------+------------+------+----------------+---------+---------+-------+------+----------+-------------+
1 row in set, 2 warnings (0.00 sec)

root@192.168.0.254 3307 [employees]>desc select * from salaries s force index(emp_no) where emp_no=10001 and from_date like '1986%';    //加上force index 后除了type=ref之外 extra还用到了icp特性
+----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-----------------------+
| id | select_type | table | partitions | type | possible_keys | key    | key_len | ref   | rows | filtered | Extra                 |
+----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-----------------------+
|  1 | SIMPLE      | s     | NULL       | ref  | emp_no        | emp_no | 4       | const |   17 |    11.11 | Using index condition |
+----+-------------+-------+------------+------+---------------+--------+---------+-------+------+----------+-----------------------+

```
4、range
索引范围查询，主要出现在 >,<,between,in,like等
```
root@192.168.0.254 3307 [employees]>desc select * from employees d where emp_no > 10001;
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows   | filtered | Extra       |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
|  1 | SIMPLE      | d     | NULL       | range | PRIMARY       | PRIMARY | 4       | NULL | 143333 |   100.00 | Using where |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+--------+----------+-------------+
1 row in set, 1 warning (0.00 sec)


root@192.168.0.254 3306 [employees]>show index from dept_emp;
+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table    | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| dept_emp |          0 | PRIMARY  |            1 | emp_no      | A         |      326341 |     NULL | NULL   |      | BTREE      |         |               |
| dept_emp |          0 | PRIMARY  |            2 | dept_no     | A         |      326341 |     NULL | NULL   |      | BTREE      |         |               |
| dept_emp |          1 | emp_no   |            1 | emp_no      | A         |      326341 |     NULL | NULL   |      | BTREE      |         |               |
| dept_emp |          1 | dept_no  |            1 | dept_no     | A         |          16 |     NULL | NULL   |      | BTREE      |         |               |
+----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
4 rows in set (0.00 sec)
 
root@192.168.0.254 3306 [employees]>explain extended  select * from dept_emp where dept_no='d004' and emp_no >= 10001;    
+----+-------------+----------+------+------------------------+---------+---------+-------+--------+----------+-----------------------+
| id | select_type | table    | type | possible_keys          | key     | key_len | ref   | rows   | filtered | Extra                 |
+----+-------------+----------+------+------------------------+---------+---------+-------+--------+----------+-----------------------+
|  1 | SIMPLE      | dept_emp | ref  | PRIMARY,emp_no,dept_no | dept_no | 12      | const | 129992 |   100.00 | Using index condition |
+----+-------------+----------+------+------------------------+---------+---------+-------+--------+----------+-----------------------+
1 row in set, 1 warning (0.00 sec)

root@192.168.0.254 3306 [employees]>explain extended  select * from dept_emp  force index (dept_no) where dept_no='d004' and emp_no >= 10001;
+----+-------------+----------+-------+---------------+---------+---------+------+--------+----------+-----------------------+
| id | select_type | table    | type  | possible_keys | key     | key_len | ref  | rows   | filtered | Extra                 |
+----+-------------+----------+-------+---------------+---------+---------+------+--------+----------+-----------------------+
|  1 | SIMPLE      | dept_emp | range | dept_no       | dept_no | 16      | NULL | 129992 |   100.00 | Using index condition |
+----+-------------+----------+-------+---------------+---------+---------+------+--------+----------+-----------------------+
上面两条SQL,都用的是一样的索引dept_no，type为ref,下面的为range因为 type为range的，用的是二级索引，即使用了dept_no+emp_no这个主键索引，


between
root@192.168.0.254 3307 [employees]>desc select * from employees d where d.emp_no between 10001 and 10002;
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra       |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | d     | NULL       | range | PRIMARY       | PRIMARY | 4       | NULL |    2 |   100.00 | Using where |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
1 row in set, 1 warning (0.02 sec)

in
root@192.168.0.254 3307 [employees]>desc select * from employees d where d.emp_no in (10001,10003);   //in中单个值是ref,多个是range
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra       |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | d     | NULL       | range | PRIMARY       | PRIMARY | 4       | NULL |    2 |   100.00 | Using where |
+----+-------------+-------+------------+-------+---------------+---------+---------+------+------+----------+-------------+

like 

root@192.168.0.254 3307 [employees]>desc select * from employees d where d.first_name like 'C%';
+----+-------------+-------+------------+-------+---------------+---------------+---------+------+-------+----------+-----------------------+
| id | select_type | table | partitions | type  | possible_keys | key           | key_len | ref  | rows  | filtered | Extra                 |
+----+-------------+-------+------------+-------+---------------+---------------+---------+------+-------+----------+-----------------------+
|  1 | SIMPLE      | d     | NULL       | range | idx_firstname | idx_firstname | 44      | NULL | 20622 |   100.00 | Using index condition |
+----+-------------+-------+------------+-------+---------------+---------------+---------+------+-------+----------+-----------------------+


range延伸，range只能用在驱动表或者被驱动表子查询的驱动表，而不能直接用在被驱动表中


优化器特性
root@192.168.0.254 3307 [employees]>desc select * from salaries where emp_no=10001 and salary =60117;
+----+-------------+----------+------------+------+----------------+---------+---------+-------+------+----------+-------------+
| id | select_type | table    | partitions | type | possible_keys  | key     | key_len | ref   | rows | filtered | Extra       |
+----+-------------+----------+------------+------+----------------+---------+---------+-------+------+----------+-------------+
|  1 | SIMPLE      | salaries | NULL       | ref  | PRIMARY,emp_no | PRIMARY | 4       | const |   17 |   100.00 | Using where |
+----+-------------+----------+------------+------+----------------+---------+---------+-------+------+----------+-------------+
1 row in set, 1 warning (0.00 sec)

root@192.168.0.254 3307 [employees]>set optimizer_switch='condition_fanout_filter=on';     //过滤性开关
Query OK, 0 rows affected (0.00 sec)

root@192.168.0.254 3307 [employees]>desc select * from salaries where emp_no=10001 and salary =60117;
+----+-------------+----------+------------+------+----------------+---------+---------+-------+------+----------+-------------+
| id | select_type | table    | partitions | type | possible_keys  | key     | key_len | ref   | rows | filtered | Extra       |
+----+-------------+----------+------------+------+----------------+---------+---------+-------+------+----------+-------------+
|  1 | SIMPLE      | salaries | NULL       | ref  | PRIMARY,emp_no | PRIMARY | 4       | const |   17 |    10.00 | Using where |
+----+-------------+----------+------------+------+----------------+---------+---------+-------+------+----------+-------------+
```
5、index
```
索引全扫描比起表全扫描且order by 的情况下快
但是绝大部分情况下是优化对象
主要用于：
    1) 不能使用range,const,ref
    2) 只查询索引列，即不回表
    3) 使用索引进行排序或者聚合，即省略排序

例:
root@192.168.0.254 3307 [employees]>desc select emp_no from salaries where from_date = '1986-06-26';
+----+-------------+----------+------------+-------+---------------+--------+---------+------+---------+----------+--------------------------+
| id | select_type | table    | partitions | type  | possible_keys | key    | key_len | ref  | rows    | filtered | Extra                    |
+----+-------------+----------+------------+-------+---------------+--------+---------+------+---------+----------+--------------------------+
|  1 | SIMPLE      | salaries | NULL       | index | NULL          | emp_no | 4       | NULL | 2580175 |    10.00 | Using where; Using index |
+----+-------------+----------+------------+-------+---------------+--------+---------+------+---------+----------+--------------------------+
判断是否回表，extra有using index 则不回表

在聚合运算中group by 后面的列在索引或者primary key中,且查询列也是在索引当中
root@192.168.0.254 3308 [employees]>desc select from_date,count(*) from salaries group by from_date;
+----+-------------+----------+------------+-------+----------------------+--------+---------+------+---------+----------+------------------------------+
| id | select_type | table    | partitions | type  | possible_keys        | key    | key_len | ref  | rows    | filtered | Extra                        |
+----+-------------+----------+------------+-------+----------------------+--------+---------+------+---------+----------+------------------------------+
|  1 | SIMPLE      | salaries | NULL       | index | PRIMARY,emp_no,idx_1 | emp_no | 4       | NULL | 2653961 |   100.00 | Using index; Using temporary |
+----+-------------+----------+------------+-------+----------------------+--------+---------+------+---------+----------+------------------------------+
1 row in set, 1 warning (0.00 sec)

root@192.168.0.254 3308 [employees]>desc select from_date,count(*) from salaries group by emp_no,from_date;
+----+-------------+----------+------------+-------+----------------------+---------+---------+------+---------+----------+-------------+
| id | select_type | table    | partitions | type  | possible_keys        | key     | key_len | ref  | rows    | filtered | Extra       |
+----+-------------+----------+------------+-------+----------------------+---------+---------+------+---------+----------+-------------+
|  1 | SIMPLE      | salaries | NULL       | index | PRIMARY,emp_no,idx_1 | PRIMARY | 7       | NULL | 2653961 |   100.00 | Using index |
+----+-------------+----------+------------+-------+----------------------+---------+---------+------+---------+----------+-------------+
1 row in set, 1 warning (0.01 sec)

满足联合索引中前导列没有在where条件且查询列在索引或者primary key 中包含emp_no
root@192.168.0.254 3308 [employees]>desc select emp_no from salaries where from_date='1986-06-26';     //using where发生二次过滤
+----+-------------+----------+------------+-------+----------------------+--------+---------+------+---------+----------+--------------------------+
| id | select_type | table    | partitions | type  | possible_keys        | key    | key_len | ref  | rows    | filtered | Extra                    |
+----+-------------+----------+------------+-------+----------------------+--------+---------+------+---------+----------+--------------------------+
|  1 | SIMPLE      | salaries | NULL       | index | PRIMARY,emp_no,idx_1 | emp_no | 4       | NULL | 2653961 |    10.00 | Using where; Using index |
+----+-------------+----------+------------+-------+----------------------+--------+---------+------+---------+----------+--------------------------+
```
6、all
```
全表扫描
一般情况下是非常不好的执行计划，但是在进行多大个中查询超过一半以上的值时效果会更好
导致我全表扫描情况较多，没有索引，对索引列进行加工，索引列进行了隐藏类型转换，对日期类型进行like 20% --单列索引的时候，对数字列进行like '30%'

例：
单列索引对索引列进行加工
root@192.168.0.254 3308 [employees]>show index from employees;
+-----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| Table     | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression |
+-----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| employees |          0 | PRIMARY  |            1 | emp_no      | A         |      299379 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
+-----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
1 row in set (0.14 sec)

root@192.168.0.254 3308 [employees]>desc select * from employees where emp_no+1=10001;
+----+-------------+-----------+------------+------+---------------+------+---------+------+--------+----------+-------------+
| id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref  | rows   | filtered | Extra       |
+----+-------------+-----------+------------+------+---------------+------+---------+------+--------+----------+-------------+
|  1 | SIMPLE      | employees | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 299379 |   100.00 | Using where |
+----+-------------+-----------+------------+------+---------------+------+---------+------+--------+----------+-------------+
1 row in set, 1 warning (0.00 sec)

索引列进行了隐藏类型转换,一般是数据类型向字符串类型转换，解决方案是加一''，或者在相关字段用convert与cast函数转换一下

root@192.168.0.254 3308 [employees]>desc test1;
+-------+-------------+------+-----+---------+-------+
| Field | Type        | Null | Key | Default | Extra |
+-------+-------------+------+-----+---------+-------+
| id    | varchar(10) | YES  | MUL | NULL    |       |
| n     | varchar(10) | YES  |     | NULL    |       |
+-------+-------------+------+-----+---------+-------+
2 rows in set (0.04 sec)

root@192.168.0.254 3308 [employees]>show index from test1;
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression |
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| test1 |          1 | ix_id    |            1 | id          | A         |           2 |     NULL |   NULL | YES  | BTREE      |         |               | YES     | NULL       |
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
1 row in set (0.00 sec)

root@192.168.0.254 3308 [employees]>desc select * from test1 where id=10;
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | test1 | NULL       | ALL  | ix_id         | NULL | NULL    | NULL |    2 |    50.00 | Using where |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
1 row in set, 3 warnings (0.00 sec)

root@192.168.0.254 3308 [employees]>show warnings;
+---------+------+------------------------------------------------------------------------------------------------------------------------------------------------------+
| Level   | Code | Message                                                                                                                                              |
+---------+------+------------------------------------------------------------------------------------------------------------------------------------------------------+
| Warning | 1739 | Cannot use ref access on index 'ix_id' due to type or collation conversion on field 'id'                                                             |
| Warning | 1739 | Cannot use range access on index 'ix_id' due to type or collation conversion on field 'id'                                                           |
| Note    | 1003 | /* select#1 */ select `employees`.`test1`.`id` AS `id`,`employees`.`test1`.`n` AS `n` from `employees`.`test1` where (`employees`.`test1`.`id` = 10) |
+---------+------+------------------------------------------------------------------------------------------------------------------------------------------------------+
3 rows in set (0.00 sec)

对数字列进行 like '30%'

root@192.168.0.254 3308 [employees]>desc  select * from employees where emp_no like '10001%';
+----+-------------+-----------+------------+------+---------------+------+---------+------+--------+----------+-------------+
| id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref  | rows   | filtered | Extra       |
+----+-------------+-----------+------------+------+---------------+------+---------+------+--------+----------+-------------+
|  1 | SIMPLE      | employees | NULL       | ALL  | PRIMARY       | NULL | NULL    | NULL | 299379 |    11.11 | Using where |
+----+-------------+-----------+------------+------+---------------+------+---------+------+--------+----------+-------------+
1 row in set, 1 warning (0.00 sec)

对日期类型进行like 20%
root@192.168.0.254 3308 [employees]>desc select * from salaries where emp_no='10001' and from_date like '1986%';   //虽然primary key包含emp_no和from_date但使用like %后from_date用不到索引
+----+-------------+----------+------------+------+----------------+---------+---------+-------+------+----------+-------------+
| id | select_type | table    | partitions | type | possible_keys  | key     | key_len | ref   | rows | filtered | Extra       |
+----+-------------+----------+------------+------+----------------+---------+---------+-------+------+----------+-------------+
|  1 | SIMPLE      | salaries | NULL       | ref  | PRIMARY,emp_no | PRIMARY | 4       | const |   17 |    11.11 | Using where |
+----+-------------+----------+------------+------+----------------+---------+---------+-------+------+----------+-------------+
1 row in set, 1 warning (0.12 sec)

root@192.168.0.254 3308 [employees]>desc select * from salaries where emp_no='10001' and from_date='1986-06-26';
+----+-------------+----------+------------+-------+----------------+---------+---------+-------------+------+----------+-------+
| id | select_type | table    | partitions | type  | possible_keys  | key     | key_len | ref         | rows | filtered | Extra |
+----+-------------+----------+------------+-------+----------------+---------+---------+-------------+------+----------+-------+
|  1 | SIMPLE      | salaries | NULL       | const | PRIMARY,emp_no | PRIMARY | 7       | const,const |    1 |   100.00 | NULL  |
+----+-------------+----------+------------+-------+----------------+---------+---------+-------------+------+----------+-------+
1 row in set, 1 warning (0.00 sec)


```
